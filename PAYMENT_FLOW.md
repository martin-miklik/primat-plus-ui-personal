# Complete Payment Flow - Visual Guide

## ğŸ¯ User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. FREE USER WANTS PREMIUM                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    Clicks "Upgrade" button
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. LANDS ON /predplatne                                         â”‚
â”‚    - Sees plan: 199 KÄ/month                                   â”‚
â”‚    - 14 days free trial                                         â”‚
â”‚    - One big CTA button                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    Clicks plan button
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. CHECKOUT PAGE /predplatne/checkout                           â”‚
â”‚                                                                  â”‚
â”‚    LEFT SIDE:                     RIGHT SIDE:                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚  Plan Summary    â”‚          â”‚  3 Checkboxes:     â”‚        â”‚
â”‚    â”‚  - 199 KÄ/month  â”‚          â”‚  â–¡ Payment Terms   â”‚        â”‚
â”‚    â”‚  - 14 days trial â”‚          â”‚  â–¡ Payment Details â”‚        â”‚
â”‚    â”‚  - All features  â”‚          â”‚  â–¡ GDPR Consent    â”‚        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚    â”‚  GoPay Terms     â”‚          â”‚  [Proceed to       â”‚        â”‚
â”‚    â”‚  (Accordion)     â”‚          â”‚   Payment] Button  â”‚        â”‚
â”‚    â”‚  - Reason        â”‚          â”‚  (disabled until   â”‚        â”‚
â”‚    â”‚  - Amount        â”‚          â”‚   all checked)     â”‚        â”‚
â”‚    â”‚  - Frequency     â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚    â”‚  - Cancellation  â”‚                                         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                                  â”‚
â”‚    Links: https://www.primat.cz/podminky-uzivani              â”‚
â”‚           https://www.primat.cz/ochrana-osobnich-udaju         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                User checks all 3 boxes
                              â”‚
                              â–¼
                Clicks "Proceed to Payment"
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. FRONTEND API CALL                                            â”‚
â”‚                                                                  â”‚
â”‚    POST /api/v1/payments/create                                â”‚
â”‚    {                                                            â”‚
â”‚      "returnUrl": "https://primat-plus.com/predplatne/uspech?  â”‚
â”‚                    status=success",                             â”‚
â”‚      "paymentDetails": true,                                    â”‚
â”‚      "paymentTerms": true,                                      â”‚
â”‚      "gdpr": true                                               â”‚
â”‚    }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. BACKEND PROCESSING                                           â”‚
â”‚                                                                  â”‚
â”‚    - Check if user has used trial                              â”‚
â”‚      â€¢ First time: amount = 1 CZK (test), type = TRIAL         â”‚
â”‚      â€¢ Returning: amount = 19900 CZK, type = PREMIUM           â”‚
â”‚    - Create Payment record in DB                                â”‚
â”‚    - Save consent timestamps on User:                           â”‚
â”‚      â€¢ paymentDetails â†’ DateTimeImmutable                       â”‚
â”‚      â€¢ paymentTerms â†’ DateTimeImmutable                         â”‚
â”‚    - Build GoPay payment object                                 â”‚
â”‚    - Call GoPay API to create payment                           â”‚
â”‚    - Save gopay_id and gateway_url                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. BACKEND RESPONSE                                             â”‚
â”‚                                                                  â”‚
â”‚    {                                                            â”‚
â”‚      "gateway_url": "https://gate.gopay.cz/gw/v3/...",         â”‚
â”‚      "gopay_id": 3287196081,                                    â”‚
â”‚      "status": "PENDING"                                        â”‚
â”‚    }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                Frontend redirects to gateway_url
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. GOPAY PAYMENT GATEWAY                                        â”‚
â”‚                                                                  â”‚
â”‚    - User enters card details                                   â”‚
â”‚    - 3D Secure verification (if required)                       â”‚
â”‚    - Payment processing                                         â”‚
â”‚    - Recurring payment setup                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    Payment completed
                              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                         â”‚
         â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8A. USER REDIRECT  â”‚                  â”‚ 8B. WEBHOOK        â”‚
â”‚     (Immediate)    â”‚                  â”‚     (Async)        â”‚
â”‚                    â”‚                  â”‚                    â”‚
â”‚ GoPay redirects to:â”‚                  â”‚ GoPay sends to:    â”‚
â”‚                    â”‚                  â”‚                    â”‚
â”‚ https://primat-    â”‚                  â”‚ https://api.primat-â”‚
â”‚ plus.com/predplatneâ”‚                  â”‚ plus.com/api/v1/   â”‚
â”‚ /uspech?status=    â”‚                  â”‚ payments/callback? â”‚
â”‚ success&id=        â”‚                  â”‚ id=3287196081      â”‚
â”‚ 3287196081         â”‚                  â”‚                    â”‚
â”‚                    â”‚                  â”‚ Backend:           â”‚
â”‚ Frontend:          â”‚                  â”‚ - Get payment      â”‚
â”‚ - Ignores id param â”‚                  â”‚   status from GoPayâ”‚
â”‚ - Uses status=     â”‚                  â”‚ - Update Payment   â”‚
â”‚   success          â”‚                  â”‚   record           â”‚
â”‚ - Shows success UI â”‚                  â”‚ - Update User:     â”‚
â”‚ - Refreshes data   â”‚                  â”‚   â€¢ subscription   â”‚
â”‚                    â”‚                  â”‚     Type = TRIAL   â”‚
â”‚                    â”‚                  â”‚   â€¢ expiresAt =    â”‚
â”‚                    â”‚                  â”‚     +14 days       â”‚
â”‚                    â”‚                  â”‚   â€¢ hasUsedTrial   â”‚
â”‚                    â”‚                  â”‚     = true         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. SUCCESS PAGE /predplatne/uspech                              â”‚
â”‚                                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚    â”‚             âœ… Platba ÃºspÄ›Å¡nÃ¡!                     â”‚      â”‚
â”‚    â”‚                                                     â”‚      â”‚
â”‚    â”‚  ğŸ‰ 14dennÃ­ zkuÅ¡ebnÃ­ obdobÃ­ aktivovÃ¡no            â”‚      â”‚
â”‚    â”‚                                                     â”‚      â”‚
â”‚    â”‚  [Loading subscription data...]                    â”‚      â”‚
â”‚    â”‚                                                     â”‚      â”‚
â”‚    â”‚  Auto-redirect to /predplatne/sprava in 3s...     â”‚      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    After 3 seconds OR click button
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. MANAGEMENT PAGE /predplatne/sprava                          â”‚
â”‚                                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚    â”‚ Premium       â”‚ 14 days       â”‚ Next billing: â”‚           â”‚
â”‚    â”‚ Monthly       â”‚ remaining     â”‚ Dec 14, 2025  â”‚           â”‚
â”‚    â”‚ â­ ZkuÅ¡ebnÃ­   â”‚               â”‚ 199 KÄ        â”‚           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                  â”‚
â”‚    Payment Method: Card â€¢â€¢â€¢â€¢ 1234 (when available)             â”‚
â”‚                                                                  â”‚
â”‚    Payment History:                                             â”‚
â”‚    - Nov 27, 2025: 1 KÄ (Trial setup) âœ… Paid                  â”‚
â”‚                                                                  â”‚
â”‚    âš ï¸ Danger Zone:                                              â”‚
â”‚    [Cancel Subscription]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Recurring Payment (After Trial)

```
Day 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Day 14
â”‚                                                      â”‚
â”‚ User starts trial (1 KÄ payment)                   â”‚ Trial expires
â”‚ Backend saves recurring payment ID                  â”‚
â”‚                                                      â–¼
â”‚                                    Backend cron job runs:
â”‚                                    - Detects trial expiration
â”‚                                    - Calls GoPay recurring charge
â”‚                                    - Amount: 19900 CZK
â”‚                                    - No user action needed!
â”‚                                                      â”‚
â”‚                                                      â–¼
â”‚                                    Automatic charge successful
â”‚                                    - User becomes PREMIUM
â”‚                                    - ExpiresAt = +1 month
â”‚                                    - Email notification sent
â”‚
â”œâ”€â”€â”€â”€â”€â”€ User has full premium access â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
```

## âš ï¸ Critical Backend TODOs

Before production:

1. **Line 119** in `PaymentFacade.php`:
   ```php
   'email' => $user->getEmail(),  // NOT 'test@test.cz'
   ```

2. **Line 111** in `PaymentFacade.php`:
   ```php
   $notifyUrl = "https://" . $url . "/api/v1/payments/callback";  // HTTPS
   ```

3. **Environment Variables:**
   ```env
   BASE_URL=api.primat-plus.com
   GOPAY_IS_PRODUCTION=true
   ```

## ğŸ“‹ GoPay Approval Checklist

To send to GoPay for approval:

- âœ… **Live checkout URL:** `https://primat-plus.com/predplatne/checkout`
- âœ… **Reason displayed:** "Platba za prÃ©miovÃ© pÅ™edplatnÃ©"
- âœ… **Amount displayed:** "199 KÄ/mÄ›sÃ­c (fixnÃ­)"
- âœ… **Frequency displayed:** "MÄ›sÃ­ÄnÄ› po ukonÄenÃ­ zkuÅ¡ebnÃ­ho obdobÃ­"
- âœ… **Contact displayed:** Support email
- âœ… **Cancellation info:** Link to terms + button in management
- âœ… **Terms link:** https://www.primat.cz/podminky-uzivani
- âœ… **Privacy link:** https://www.primat.cz/ochrana-osobnich-udaju
- âœ… **3 consents:** All mandatory
- âœ… **PCI-DSS info:** Displayed in payment details consent

## ğŸš€ Ready to Deploy!

**Frontend:** âœ… Complete  
**Backend:** âš ï¸ 2 changes needed  
**Testing:** ğŸŸ¡ Ready for staging

